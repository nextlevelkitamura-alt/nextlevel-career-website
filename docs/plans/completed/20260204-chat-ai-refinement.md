# Implementation Plan: チャットボット風AI Refinement機能

## 1. Requirements Restatement

ユーザーの要望を整理すると、以下の改善点があります：

1. **チェックボックスではなくチャットで項目を指定**
   - 現在: チ�核ボックスで修正項目を選択
   - 新規: 自然言語で項目を指定（例: "タイトルと仕事内容を修正して"）

2. **チャットでどのように直して欲しいかを指示**
   - 現在: テキスト入力で追加指示
   - 新規: チ�場のように自然言語で会話しながら修正

3. **AIの応答を確認してから適用**
   - 修正案をプレビュー表示
   - 適用/やり直しの選択が可能
   - 確認後にデータを更新

## 2. Risk Assessment

- **MEDIUM**: LLMの意図解釈の誤り — "給与を直して"で全給与関連フィールドが変更されるリスク
- **MEDIUM**: 過修正の複雑さ — 会話履歴を考慮した修正の難しさ
- **LOW**: UI実装の複雑さ — 既存のChatInterfaceパターンを活用可能
- **MEDIUM**: パフォーマンス — LLM呼び出しの頻度とコスト

**対策**:
- 確認ステップの強制（修正案プレビューの表示）
- 影響範囲の明示（変更されるフィールドを明示）
- ガードレールの実装（危険な変更の検知）

## 3. Dependencies

- Next.js 15
- Gemini 2.0 Flash API（AI）
- Supabase（既存スキーマ）
- Tailwind CSS（スタイリング）
- shadcn/uiコンポーネント（Dialog, ScrollAreaなど）

## 4. Implementation Phases

### Phase 1: 基本的なチャットUIコンポーネントの作成

**対象ファイル**: 新規作成

**タスク**:
- [ ] `ChatAIRefineDialog.tsx` - チャットUI全体を管理
  - 会話履歴の表示エリア
  - ユーザー入力欄
  - 送信ボタン
  - メッセージ一覧表示
  - スクロール機能

- [ ] `ChatMessage.tsx` - メッセージ表示コンポーネント
  - ユーザーメッセージ（右寄せ）
  - AI応答（左寄せ、アイコン付き）
  - タイムスタンプ表示

- [ ] `RefinementPreview.tsx` - 修正案プレビューコポーネント
  - 差分表示（変更前後の比較）
  - 変更フィールドのリスト表示
  - 適用/やり直しボタン

- [ ] 会話履歴の状態管理:
  ```typescript
  interface ChatMessage {
    id: string;
    role: 'user' | 'assistant';
    content: string;
    timestamp: Date;
    type: 'text' | 'refinement_preview';
    refinementData?: {
      originalFields: Record<string, any>;
      proposedFields: Record<string, any>;
      changedFields: string[];
    };
  }
  ```

**実装イメージ**:
```
┌─────────────────────────────────────────────────┐
│  AIで求人を修正                                 [×]  │
├─────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────┐  │
│  │ 会話履歴エリア（最大10件程度）            │  │
│  │                                           │  │
│  │ ┌─────────────────────────────────────┐   │  │
│  │ │ 👤 タイトルと仕事内容を修正して        │   │  │
│  │ └─────────────────────────────────────┘   │  │
│  │                                           │  │
│  │ ┌─────────────────────────────────────┐   │  │
│  │ │ 🤖 AIの応答                         │   │  │
│  │ │ 承知しました。以下の項目を修正します：│   │  │
│  │ │ • タイトル                          │   │  │
│  │ │ • 仕事内容                          │   │  │
│  │ │ 具体的な修正内容を教えてください。  │   │  │
│  │ └─────────────────────────────────────┘   │  │
│  │                                           │  │
│  │ ┌─────────────────────────────────────┐   │  │
│  │ │ [修正案プレビュー]                   │   │  │
│  │ │                                      │   │  │
│  │ │ 【変更前】                           │   │  │
│  │ │ タイトル: 事務アシスタント          │   │  │
│  │ │ 仕事内容: データ入力を行います        │   │  │  │
│  │ │                                      │   │  │
│  │ │ 【変更後】                           │   │  │
│  │ │ タイトル: 【未経験OK・駅チカ】事務  │   │  │
│  │ │ 仕事内容: 主に電話対応とデータ入力...  │   │  │
│  │ │                                      │   │  │
│  │ │ ┌──────────┐ ┌──────────┐           │   │  │
│  │ │ │ 適用する │ │ やり直す │           │   │  │
│  │ │ └──────────┘ └──────────�           │   │  │
│  │ └─────────────────────────────────────┘   │  │
│  └───────────────────────────────────────────┘  │
│                                                 │
│  ┌─────────────────────────────────────────┐  │
│  │ 指示を入力...                            │  │
│  └─────────────────────────────────────────┘  │
│                              [送信]           │
└─────────────────────────────────────────────────┘
```

### Phase 2: 自然言語での項目抽出と修正案生成

**対象ファイル**: `app/admin/actions.ts`

**タスク**:

#### 2-1: refineJobWithAI関数の拡張

- [ ] 新規関数 `chatRefineJobWithAI` を作成
- [ ] 以下の機能を実装:
  1. 会話履歴を考慮したプロンプト生成
  2. 自然言語からの修正フィールド抽出
  3. 修正案の生成
  4. ガードレールチェック

**プロンプト設計**:
```typescript
const buildRefinementPrompt = (
    currentData: ExtractedJobData,
    userMessage: string,
    conversationHistory: ChatMessage[]
) => `
あなたは求人情報を改善・修正するプロの求人コンサルタントAIです。

## 会話の履歴
${conversationHistory.map(m => `${m.role}: ${m.content}`).join('\n')}

## 現在の求人データ
${formatCurrentData(currentData)}

## 最新のユーザー指示
${userMessage}

## フィールド定義と同義語
以下のフィールドを認識します：

**基本情報**:
- title: タイトル、求人タイトル、仕事名、お仕事名
- description: 仕事内容、業務内容、職務内容、仕事の詳細
- requirements: 応募資格、条件、応募条件

**給与関連**:
- salary: 給与、時給、賃金、報酬、給料
- salary_type: 給与形態
- hourly_wage: 時給、時間給
- salary_description: 給与詳細
- raise_info: 昇給
- bonus_info: 賞与
- commute_allowance: 交通費、通勤手当

**勤務先情報**:
- nearest_station: 最寄駅、最寄り駅
- location_notes: 勤務地備考、アクセス
- workplace_name: 勤務先名、会社名
- workplace_address: 勤務地住所、住所
- workplace_access: アクセス、アクセス方法

## カテゴリベースの抽出
以下のキーワードを含む場合は、カテゴリ全体を対象とします：

- "給与"、"時給"、"賃金" などのキーワード → 給与関連全フィールド
- "勤務地"、"勤務先"、"アクセス" などのキーワード → 勤務先情報全フィールド

## 指示
1. ユーザーの指示から修正対象フィールドを抽出してください
2. 抽出されたフィールドのみを修正してください
3. その他のフィールドは現在の値を維持してください
4. マスタデータに準拠した表現を使用してください
5. 必須フィールド（title, area, salary等）が空にならないようにしてください

## 出力形式
{
  "targetFields": ["title", "description"],
  "reasoning": "フィールド選定の理由",
  "proposedChanges": {
    "title": "修正後のタイトル",
    "description": "修正後の仕事内容"
  }
}
`;
```

- [ ] 同義語マッピングの実装
- [ ] カテゴリベースのフィールド抽出
- [ ] ガードレールの実装:
  - 数値フィールドの大幅な変動チェック
  - 配列フィールドの要素数チェック
  - 必須フィールドの空値チェック

#### 2-2: エラーハンドリングの強化

- [ ] カスタムエラータイプの定義
- [ ] 各種エラーケースのメッセージ実装:
  - `RATE_LIMIT`: レート制限
  - `INVALID_RESPONSE`: 不正応答
  - `FIELD_EXTRACTION_FAILED`: フィールド抽出失敗
  - `VALIDATION_ERROR`: バリデーションエラー

### Phase 3: 確認・適用フローの実装

**対象ファイル**: `ChatAIRefineDialog.tsx`

**タスク**:

#### 3-1: 修正案プレビューの実装

- [ ] `RefinementPreview.tsx` で差分表示:
  - 変更前後の値を並べて表示
  - 変更されたフィールドのみハイライト
  - 削除: 赤色取り消し線
  - 追加: 緑色背景

#### 3-2: 適用・やり直しボタン

- [ ] 「適用」ボタン:
  - 修正案をデータに反映
  - サーバーアードで更新
  - 成功トースト表示

- [ ] 「やり直し」ボタン:
  - 入力欄に再プロンプトを表示
  - 追加指示を入力可能に

- [ ] 「キャンセル」ボタン:
  - チャットを終了
  - 変更を破棄

#### 3-3: ガードレールの組み込み

- [ ] 変更前に以下をチェック:
  - 必須フィールドが空になっていないか
  - 配列フィールドの要素数が適切か
  - 数値フィールドの変動が妥当か

- [ ] 警告メッセージの表示:
  - 大幅な変更がある場合は警告
  - ユーザーに確認を求めるダイアログ

### Phase 4: 管理画面への統合

**対象ファイル**: `EditJobForm.tsx`, `create/page.tsx`, `DraftJobEditor.tsx`

**タスク**:
- [ ] 既存の `JobAIRefineButton` を `ChatAIRefineDialog` に置き換え
- [ ] フォームデータを渡すインターフェース調整
- [ ] 適用後のデータ更新ロジック実装

**実装例**:
```tsx
// EditJobForm.tsx
<ChatAIRefineDialog
    currentJob={job}
    onRefined={(refinedData) => {
        setTitle(refinedData.title);
        setDescription(refinedData.description);
        // ... 他のフィールドも更新
    }}
/>
```

### Phase 5: テスト・検証

**タスク**:

#### 5-1: 各種パターンのテスト

- [ ] 単一項目修正: "タイトルを修正して"
- [ ] 複数項目修正: "タイトルと仕事内容を修正して"
- [ ] カテゴリ指定: "給与関連を修正して"
- [ ] 具体的指示: "未経験OKを強調して、駅チカに書き換えて"
- [ ] エッジケース: 空指示、不明確な指示

#### 5-2: エッジケースの検証

- [ ] 意図しないフィールド指定
- [ ] 不可能な修正要求
- [ ] レート制限超過時の挙動
- [   マルチモーダルでの会話の管理

#### 5-3: パフォーマンスの最適化

- [ ] 会話履歴の適切な管理（最新10件）
- [ ] 不要な再レンダリングの防止
- [ ] LLM呼び出しの最適化

## 5. Estimated Complexity

- **High**

理由:
- 新規コンポーネントの作成（3つ）
- LLMプロンプトの複雑化（意図抽出、会話履歴考慮）
- 確認フローの実装（プレビュー、適用/やり直し）
- ガードレールの実装
- 既存機能との統合

## 6. Critical Files

| ファイル | 変更内容 | 優先度 |
|---|---|---|
| `components/admin/ChatAIRefineDialog.tsx` | チャットUIコンポーネント（新規作成） | **HIGH** |
| `components/admin/ChatMessage.tsx` | メッセージ表示コンポーネント（新規作成） | **HIGH** |
| `components/admin/RefinementPreview.tsx` | 修正案プレビューコョンポーネント（新規作成） | **HIGH** |
| `app/admin/actions.ts` | `chatRefineJobWithAI`関数追加、既存`refineJobWithAI`は保持 | **HIGH** |
| `app/admin/jobs/[id]/edit/EditJobForm.tsx` | 新しいUIコンポーネントに置き換え | **HIGH** |
| `app/admin/jobs/create/page.tsx` | 新しいUIコンポーネントに置き換え | **HIGH** |
| `components/admin/JobAIRefineButton.tsx` | 保持（オプションで既存UIを選択可能にする場合） | **LOW** |

## 7. Verification Checklist

### 機能確認
- [ ] チャットUIが開閉できる
- [ ] 自然言語で項目を指定できる
- [ ] AIが修正案を生成する
- [ ] 修正案がプレビュー表示される
- [ ] 適用ボタンでデータが更新される
- [ ] やり直しで再プロンプトができる
- [ ] キャンセルで変更が破棄される

### UI/UX確認
- [ ] 会話履歴が正しく表示される
- [ ] メッセージが適切にスクロールされる
- [ ] AI応答が見やすいレイアウト
- [ ] 修正案の差分が分かりやすい
- [ ] ボタンの配置が直感的

### データ整合性確認
- [ ] 必須フィールドが空にならない
- [ ] 配列フィールドが正しく配列として保存される
- [ ] マスタデータに準拠した値になっている
- [ ] 変更履歴が正しく記録される

### エッジケース確認
- [ ] 曖昧な指示の場合に適切なエラーメッセージ
- [ ] 不可能な修正要求の場合にガードレールが機能する
- [ ] 大幅な変更前に警告が表示される
- [ ] レート制限時に適切なメッセージが表示される

### ビルド確認
- [ ] `npm run build` でエラーなし
- [ ] `npx tsc --noEmit` で型エラーなし
- [ ] Vercelデプロイ成功

## 8. Implementation Order

1. **Phase 1** (チャットUIコンポーネント作成)
2. **Phase 2** (自然言語抽出と修正案生成)
3.  **Phase 3** (確認・適用フロー)
4. **Phase 5** (テスト・検証)
5.  **Phase 4** (管理画面への統合) - Phase 1-3完了後

## 9. Notes

### 既存UIの保持について
- 既存の`JobAIRefineButton`（チェックボックス式）は、新UIに完全に置き換える
- または、オプションとして両方のUIを提供（ユーザーが選択可能）

### 会話履歴の管理
- 最新10件程度に制限してメモリ効率を確保
- セ�過去のメッセージは適切にアーカイブ

### LLMコストについて
- 会話形式になるため、LLM呼び出し回数が増加する可能性
- 適切なプロンプト設計とキャッシュでコスト最適化

### 同義語マッピングの拡張
- 初回は基本的な同義語のみ実装
- ユーザーフィードバックで徐々に拡張

### AI抽出精度
- 初回の実装では80%程度の精度を目標
- 誤解があった場合はプロンプトを調整
